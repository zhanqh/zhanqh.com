<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width"> -->
    <title>zhan's blog</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="body-container">
    <header class="header clearfix">
        <div class="site-name-wrapper">
            <a href="/" class="site-name">zhan's blog</a>
        </div>
        <div class="nav-menu">
            <a href="/"><i class="fa fa-home"> 首页</i></a>
            <a href="/data-observe.html" class="current"><i class="fa fa-line-chart"> 数据</i></a>
            <a href="/archives"><i class="fa fa-book"> 笔记</i></a>
            <!-- <a href=""><i class="fa fa-navicon"> 归档</i></a> -->
            <a href="/app-bus.html"><i class="fa fa-mobile"> bus app</i></a>
        </div>
    </header>
    <main>
        <div class="article">
            <h2>藏地之旅自驾游记分析，哪些人最向往远方</h2>

            <p>西藏，在许多人眼中是离天堂最近的地方，雪域高原的碧水蓝天、神秘的宗教圣地，去一趟西藏净化心灵成为了许多人最初的梦想。随着国内基础建设的不断完善，现今去西藏已经有很多种可供选择的方式，最便捷的坐飞机直飞拉萨、青藏铁路、四川或者云南出发的大巴与拼车，以及最为神圣的自驾进藏。我没有自驾进藏的经历，但是我曾经从广州出发坐火车去，历时53个小时，整整两天多，是中国运行时长最长的一班车次。如果说坐火车进藏还能叫做旅行，那自驾进藏就得算是一场修行了。自驾进藏动辄就是几千公里的路程，每一公里都需要自己用车轮去丈量。坐火车那时一路看风景，累了就睡觉。每一位自驾进藏的游者都是充满了勇气，心灵在天堂、身体在地狱。</p>

            <h3>开始动手</h3>

            <p>国内汽车行业流量最大的网站汽车之家以前有一个论坛精选专题叫藏地之旅，是通过网站编辑在无数的游记中人工筛选出来的自驾进藏精选游记，以前在论坛精选推荐那就有入口，现在只能通过搜索找到入口。<div class="image"><img src="/static/images/1.png"></div></p>

            <p>作为一个车迷，这个版块的内容我是经常看的，里边的自驾进藏游记大都看过，经过编辑人工筛选之后，内容质量已经非常高了，并且也都是真实的自驾游，结合汽车之家的车主认证信息，这简直就是一个优质内容源。于是我把这好几百篇游记全部爬取下来，统计自驾进藏的出发时间、出发地以及自驾的车型等等，进行了一个挺有意思的分析。接下来先讲讲大致的实现过程。<div class="image"><img src="/static/images/2.png"></div>
            通过汽车之家的综合搜索进入到藏地之旅索引页面 http://club.autohome.com.cn/jingxuan/114/1，每一篇游记的信息包含在</a> li 列表中，点击跳转到详情页。<div class="image"><img src="/static/images/3.png"></div>
            整体的爬取逻辑很简单，从入口开始在 li 列表中中找出每一篇游记的链接，然后请求详情页获取目标信息。通过遍历入口索引页的下一页标签便能获取全部的索引页，并对全部索引页进行解析后请求详情页获取目的信息。</p>

            <h3>目标信息解析提取难点</h3>

            <p>索引页的信息提取很常规，通过选择器定位到节点获取 href 属性，然后在生成新的请求即可。详情页解析有点儿蛋疼。汽车之家的论坛页面还没有使用前后端分离的开发方式，通过查看网页源代码、分析页面请求能够很明显地看出游记内容信息是直接在 HTML 代码中一起返回的，前端写好模板，通过后端服务器渲染插入变量，耦合的方式显而易见。单纯地使用 CSS 或者 XPath 选择器很难提取到目标信息。在用户信息中，由于每个用户信息完善度不一致，一些用户是没有某些信息的，而渲染出来的页面是直接用 li 标签包含这些信息，没有类属性或者 ID 属性上的区别。<div class="image"><img src="/static/images/4.png"></div>
            比如这里的用户所在地、认证车信息以及用户勋章都是直接在后端渲染到 li 标签里。关键是这些 li 标签的数量是不确定的，有些用户可能没有认证车只有关注车，或者某些用户没有填写自己的所在地信息。渲染出来的情况是不确定，无法使用类/ID属性，也无法使用索引顺序来解析、获取目标信息。我的解决方法是结合正则表达式或者 xpath 选择器的 contains 方法，只要是渲染出来的信息，那么它的说明信息（类似对象的键）是不会变的，所以只要匹配到了说明信息的关键字，同时做好异常处理便能很好地提取到目标信息。<br/>
            <div class="image"><img src="/static/images/5.png"></div></p>

            <h3>自驾进藏热门出发地可视化结果</h3>

            <p>把全部的游记都爬取下来存储到 MongoDB 数据库之后，通过 Python 脚本清洗数据、统计结果。
            <div id="tibetan"></div>
            汽车之家藏地之旅栏目精选游记主要是近5年内的自驾游记。自驾进藏游客来源，四川位列第一，广东、北京、河南分别位列其后3名。这里需要说明的是，这些数据不能代表全部的自驾进藏行为，首先运营性质的进藏行为不算，毗邻西藏的云南、四川、青海会有不少专门从事旅游包车的情况；其次，不同地方的互联网普及程度不同，并非所有自驾进藏的驴友都会到汽车之家上发游记。不过，汽车之家作为国内最大的汽车垂直领域网站，互联网普及程度在不同大方车主之间的差异应该是挺小的。</p>

            <p>四川作为西藏的相邻省份，尤其是川西地区与西藏有着密切的联系，自驾进藏的时间成本、财力成本也都是相对较低的，四川的经济也明显好于云南、青海、新疆等西藏的其他相邻省份。并且从四川进藏的318国道川藏线沿途的景色也是非常地惊险壮观的，其他省份自驾进藏也有不少是途径四川走川藏线的。</p>

            <p>四川之后便是广东地区，作为广东人我也有一颗自驾进藏的心，总有一天我也会去的。相比之下，华东地区的自驾进藏热度便没有那么高。首都北京的自驾进藏热度不意外，毕竟城会玩，首都人民肯定是不会落后的。河南省能排得这么靠前到是挺意外的。</p>

            <h3>自驾进藏车型统计</h3>

            <p>了解完自驾进藏的省份分布情况，接下来自驾进藏车型分布那是必不可少的，先看结果。
                <div id="tibetan-car"></div>
            </p>

            <p>前面已经提到了用户会有认证车信息，那么这个车型结果，我是如何得出来的呢？汽车之家的论坛分成了3种类型：车型论坛、主题论坛与地方论坛。比如：山东论坛链接地址为 http://club.autohome.com.cn/bbs/thread-a-100023-36274620-1.html，自驾游论坛链接地址为http://club.autohome.com.cn/bbs/thread-o-200042-36309451-1.html，大众高尔夫论坛链接地址为 http://club.autohome.com.cn/bbs/thread-c-871-35065778-1.html，通过观察能够发现，车型论坛代号为</a> c，主题论坛代号为 o，地方论坛代号为 a。同时汽车之家的论坛还有一个潜规则，用户发送的游记内容应当与所在论坛主题有相关。普拉多论坛发表的游记应当有普拉多车型，山东论坛发表的游记应该是山东人。那么结果便比较清晰了，首先对详情页的链接进行归类分析，车型论坛发表的自驾进藏游记车型为该论坛的车型，自驾游论坛与地方论坛的游记用户若有认证车，那么自驾车型为该认证车，如果没有认证车信息，那就只能人工确认自驾车型。</p>

            <p>在这几百篇游记中，单一车型统计，前15名除了神车五菱宏光之外其他的车型全部是 SUV。毫无疑问，西藏山高路险，通过性好以及有一定的脱困能力的 SUV 是很有必要的。排名第一丰田 RAV4，一点都不意外，其实在统计出结果之前就能猜到丰田系是第一，不确定的只是丰田哪一款 SUV 会拿第一。前 15 名丰田占了3款，RAV4、普拉多与汉兰达，丰田的可靠性真的不是盖的，这也从侧面印证了西藏遍地是牛头车（丰田）。RAV4 之后的3名也全是日系的 SUV。日系可靠性高、皮实耐用，几千公里的长途奔袭，可靠的车辆是自驾旅途的基本保障。比较意外的是，斯巴鲁森林人居然排到了第二。纯进口的森林人与另外3款日系主流 SUV 在销量可是差了一个数量级，2016 年 CR-V、奇骏与 RAV4 在国内的销量都是十几万辆，而斯巴鲁整个品牌的销量都不到5万辆。不过，森林人的四驱能力在同级别紧凑型 SUV 中是数一数二的，森林人的用户群体应当是有更多的户外活动，另外三者是有比较强的居家属性。相比之下，作为前 15 名中销量最高的途观却排到了第 9 的位置，途观的车主似乎没那么向往远方。最意外的是排在途观之后的昂科雷，作为纯进口的中大型 SUV 昂科雷的销量仅仅只是千辆级别，却有这么多的车主自驾进藏，我的理解是别克高端车主很热爱生活、也乐于表达对生活的热爱，所以才采集到了这么多昂科雷自驾游数据。</p>

            <h3>关于爬虫的发现</h3>

            <p>最后，再来讲讲爬虫时发现的一些情况。在爬取这些游记信息的时候，就算修改了 headers 直接爬取肯定是很快就会被 ban 的，还没爬到几条游记就会服务器就返回 429 请求过于频繁的状态码了。我测试了两种方式，一个是使用 IP 代理单机爬取，另一个就是不用 IP 代理的分布式爬取。前者我使用的是快代理的服务，免费的代理几乎不可用，普通会员的付费开放代理只能保证40%的可用率，代理的有效期也仅仅只是在5分钟到1个小时之间，要保证40%的可用率还得没5分钟更换一次代理。这个其实还是比较好解决的，写一个脚本，定期请求快代理的 API 接口拉回代理节点数据，放入 redis 数据库中，再用 Scrapy 中间件去获取最新的代理即可。关键是这些开发代理的延迟太高了，同一个 request 请求如果连续3次遇到不可用的代理，这个概率还是蛮高的，因为只能保证40%的可使用率，3次请求错误，Scrapy 就会放弃这个请求了。所以又得对这种 TimeoutError、TCPTimedOutError 情况做异常处理。由于糟糕的代理质量使得爬取效率不是很理想。相比之下，限制请求频率、不使用 IP 代理的分布式代理效率反而更高了。</p>

            <p>我采用的是腾讯云的节点来实现分布式爬取。我的个人站点是搭建在腾讯云的，使用的是包月付费的模式，不限流量限带宽。而拿来做分布式爬虫节点的云主机选择按使用量付费的模式，双核4G的节点一个小时只需要不到9毛钱。并且只计出网流量，不计入网流量，这个对于爬虫来说非常赞，爬虫获取数据几乎都是入网流量。换个角度来说，这种方式相当于以一个小时 1 块钱的成本获取到了一个优质的专线代理，延时率就相当于平时正常的上网。实测结果是，将请求频率限制到两秒钟一个请求时，这种不使用代理的分布式爬取效率明显要比较高。其实这里的分布式并不是提升机器性能，单机爬取时，我可以使用多进程，以目前爬取的数据量来说，MBP 还是能够撑得住，但是就只有一个固定本机 IP 了。不过缺点就是每次使用的时候都得配置环境，这个有点繁琐。</p>

        </div>
    </main>
</body>
<script src="https://cdn.bootcss.com/echarts/3.6.2/echarts.min.js"></script>
<script src="/static/js/map/china.js"></script>
<script src="/static/js/tibetan.js"></script>
<script src="/static/js/tibetancar.js"></script>
</html>